## Урок 5. Spark Streaming. Stateful streams.

##### Задание 1. Запустить агрегацию по временному окну в разных режимах.

Для выполнения задания, я пересоздал топик `shadrin_iris` с перемешанными данными.

1\.1\. Подключаемся к серверу

```bash
ssh BD_274_ashadrin@89.208.223.141 -i ~/.ssh/id_rsa_gb_spark
```


1\.2\. Запускаем `pyspark`. 

```bash
[BD_274_ashadrin@bigdataanalytics-worker-0 ~]$ export SPARK_KAFKA_VERSION=0.10
[BD_274_ashadrin@bigdataanalytics-worker-0 ~]$ /spark2.4/bin/pyspark --packages org.apache.spark:spark-sql-kafka-0-10_2.11:2.4.5 --driver-memory 512m --master local[1]
```

1\.3\. Прочитаем топик `shadrin_iris`, вспомним что лежит в Кафке.

Далее делаем стандартные импорты и определяем константы, схему данных и сам стрим, который читает топик `shadrin_iris` из Кафки.

```python
from pyspark.sql import functions as F
from pyspark.sql.types import StructType, StringType, FloatType

kafka_brokers = "bigdataanalytics-worker-0.novalocal:6667"

raw_data = spark.readStream. \
    format("kafka"). \
    option("kafka.bootstrap.servers", kafka_brokers). \
    option("subscribe", "shadrin_iris"). \
    option("startingOffsets", "earliest"). \
    option("maxOffsetsPerTrigger", "6"). \
    load()

schema = StructType() \
    .add("sepalLength", FloatType()) \
    .add("sepalWidth", FloatType()) \
    .add("petalLength", FloatType()) \
    .add("petalWidth", FloatType()) \
    .add("species", StringType())
```
   
1\.4\. WATERMARK и дубликаты внутри одного батча.

Waterwark - одна из настроек стрима для сохранения состояния этого стрима внутри чекпойнта. Добавим колонку с временем обработки микробатча. Она понадобится для настройки чекпойнта и вотермарки.
   
```python
extended_iris = raw_data \
    .select(F.from_json(F.col("value").cast("String"), schema).alias("value"), "offset") \
    .select("value.*", "offset") \
    .withColumn("receive_time", F.current_timestamp())

extended_iris.printSchema()
```

    root
     |-- sepalLength: float (nullable = true)
     |-- sepalWidth: float (nullable = true)
     |-- petalLength: float (nullable = true)
     |-- petalWidth: float (nullable = true)
     |-- species: string (nullable = true)
     |-- offset: long (nullable = true)
     |-- receive_time: timestamp (nullable = false)


В методе `console_output` обязательно указываем папку, в которой будет храниться чекпойнт. 

```python
def console_output(df, freq):
    return df.writeStream \
        .format("console") \
        .trigger(processingTime='%s seconds' % freq ) \
        .option("checkpointLocation", "checkpoints/duplicates_console_chk") \
        .options(truncate=False) \
        .start()
```

Запускаем стрим и смотрим как растёт наш чекпойнт (команда `hdfs dfs -du -h checkpoints/duplicates_console_chk`).

```python
stream = console_output(extended_iris , 5)
stream.stop()
```

Задаём вотермарку, которая должна очищать чекпоинт. Первый параметр - назване колонки, на которую смотрит вотермарка, второй параметр - гарантированное время жизни информации о сообщении в чекпойнте. Именно для этого мы добавляли столбец `receive_time`.

```python
waterwarked_iris = extended_iris.withWatermark("receive_time", "30 seconds")
waterwarked_iris.printSchema()
```

Схема не поменялась. Вотермарка только следит за чекпойнтом, но никак не аффектит наши данные. 

Теперь данные можно проверить на наличие дубликатов. Дубли проверяем по двум колонкам: `species` и `receive_time`. Таким образом будут отсеиваться дубли по полю `species` внутри одного микробатча, так как столбец `receive_time` для всех записей внутри этого микробатча одинаковый. 

```python
deduplicated_iris = waterwarked_iris.drop_duplicates(["species", "receive_time"])
```

Чтобы всё заработало, нужно предварительно очистить чекпойнт (команда `hdfs dfs -rm -r checkpoints/duplicates_console_chk`).

```python
stream = console_output(deduplicated_iris , 20)
```

    -------------------------------------------                                     
    Batch: 0
    -------------------------------------------
    +-----------+----------+-----------+----------+----------+------+-----------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species   |offset|receive_time           |
    +-----------+----------+-----------+----------+----------+------+-----------------------+
    |5.0        |3.0       |1.6        |0.2       |setosa    |2     |2021-01-02 19:32:59.999|
    |6.3        |3.3       |4.7        |1.6       |versicolor|1     |2021-01-02 19:32:59.999|
    |6.3        |2.8       |5.1        |1.5       |virginica |0     |2021-01-02 19:32:59.999|
    +-----------+----------+-----------+----------+----------+------+-----------------------+
    
    -------------------------------------------                                     
    Batch: 1
    -------------------------------------------
    +-----------+----------+-----------+----------+----------+------+-----------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species   |offset|receive_time           |
    +-----------+----------+-----------+----------+----------+------+-----------------------+
    |6.1        |3.0       |4.6        |1.4       |versicolor|7     |2021-01-02 19:33:15.367|
    |5.7        |3.8       |1.7        |0.3       |setosa    |6     |2021-01-02 19:33:15.367|
    +-----------+----------+-----------+----------+----------+------+-----------------------+
    
    -------------------------------------------                                     
    Batch: 2
    -------------------------------------------
    +-----------+----------+-----------+----------+----------+------+-----------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species   |offset|receive_time           |
    +-----------+----------+-----------+----------+----------+------+-----------------------+
    |5.1        |3.8       |1.6        |0.2       |setosa    |12    |2021-01-02 19:33:28.934|
    |5.5        |2.4       |3.8        |1.1       |versicolor|14    |2021-01-02 19:33:28.934|
    +-----------+----------+-----------+----------+----------+------+-----------------------+


В каждом микробатче только записи с уникальным значением по колонке `species`. По значению в `offset` видно что не все сообщения попадают в вывод.

```python
stream.stop()
```

Без указания в `drop_duplicates` столбца с временнОй меткой, дубликаты отсеивались бы по всем данным. И все эти данные хранились бы в чекпойнте, даже не смотря на то что у нас настроена вотермарка. Чтобы не допустить раздувания чекпойнта, указывается столбец с временнОй меткой. Вотермарка ограничивает "глубину" данных не только для поиска дубликатов, но и для любой группирующей функции. 

1\.5\. WINDOW и дубликаты за периоды времени.

Создаём временное окно. В структуру датафрейма добавился новый столбец.

```python
windowed_iris = extended_iris.withColumn("window_time", F.window(F.col("receive_time"), "2 minutes"))
windowed_iris.printSchema()
```

    root
     |-- sepalLength: float (nullable = true)
     |-- sepalWidth: float (nullable = true)
     |-- petalLength: float (nullable = true)
     |-- petalWidth: float (nullable = true)
     |-- species: string (nullable = true)
     |-- offset: long (nullable = true)
     |-- receive_time: timestamp (nullable = false)
     |-- window_time: struct (nullable = false)
     |    |-- start: timestamp (nullable = true)
     |    |-- end: timestamp (nullable = true)
    

Устанавливаем вотермарку для очистки чекпоинта и удаляем дубли в каждом окне.

```python
waterwarked_windowed_iris = windowed_iris.withWatermark("window_time", "2 minutes")
deduplicated_windowed_iris = waterwarked_windowed_iris \
    .drop_duplicates(["species", "window_time"])
```

Проверяем как удаляются дубли из каждого окна.

```python
stream = console_output(deduplicated_windowed_iris , 20)
```
    
<details>
<summary>Результат выполнения в консоли</summary>

    -------------------------------------------                                     
    Batch: 0
    -------------------------------------------
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species   |offset|receive_time           |window_time                               |
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |6.3        |2.8       |5.1        |1.5       |virginica |0     |2021-01-02 19:41:50.824|[2021-01-02 19:40:00, 2021-01-02 19:42:00]|
    |5.0        |3.0       |1.6        |0.2       |setosa    |2     |2021-01-02 19:41:50.824|[2021-01-02 19:40:00, 2021-01-02 19:42:00]|
    |6.3        |3.3       |4.7        |1.6       |versicolor|1     |2021-01-02 19:41:50.824|[2021-01-02 19:40:00, 2021-01-02 19:42:00]|
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    
    -------------------------------------------                                     
    Batch: 1
    -------------------------------------------
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species   |offset|receive_time           |window_time                               |
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |5.7        |3.8       |1.7        |0.3       |setosa    |6     |2021-01-02 19:42:03.314|[2021-01-02 19:42:00, 2021-01-02 19:44:00]|
    |6.1        |3.0       |4.6        |1.4       |versicolor|7     |2021-01-02 19:42:03.314|[2021-01-02 19:42:00, 2021-01-02 19:44:00]|
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    
    -------------------------------------------                                     
    Batch: 2
    -------------------------------------------
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species|offset|receive_time|window_time|
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    
    -------------------------------------------                                     
    Batch: 3
    -------------------------------------------
    +-----------+----------+-----------+----------+---------+------+-----------------------+------------------------------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species  |offset|receive_time           |window_time                               |
    +-----------+----------+-----------+----------+---------+------+-----------------------+------------------------------------------+
    |6.7        |2.5       |5.8        |1.8       |virginica|19    |2021-01-02 19:42:40.004|[2021-01-02 19:42:00, 2021-01-02 19:44:00]|
    +-----------+----------+-----------+----------+---------+------+-----------------------+------------------------------------------+
    
    -------------------------------------------                                     
    Batch: 4
    -------------------------------------------
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species|offset|receive_time|window_time|
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    
    -------------------------------------------                                     
    Batch: 5
    -------------------------------------------
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species|offset|receive_time|window_time|
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    
    -------------------------------------------                                     
    Batch: 6
    -------------------------------------------
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species|offset|receive_time|window_time|
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    +-----------+----------+-----------+----------+-------+------+------------+-----------+
    
    -------------------------------------------                                     
    Batch: 7
    -------------------------------------------
    +-----------+----------+-----------+----------+---------+------+-----------------------+------------------------------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species  |offset|receive_time           |window_time                               |
    +-----------+----------+-----------+----------+---------+------+-----------------------+------------------------------------------+
    |4.9        |3.1       |1.5        |0.2       |setosa   |46    |2021-01-02 19:44:00.004|[2021-01-02 19:44:00, 2021-01-02 19:46:00]|
    |6.0        |3.0       |4.8        |1.8       |virginica|42    |2021-01-02 19:44:00.004|[2021-01-02 19:44:00, 2021-01-02 19:46:00]|
    +-----------+----------+-----------+----------+---------+------+-----------------------+------------------------------------------+
    
    -------------------------------------------                                     
    Batch: 8
    -------------------------------------------
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species   |offset|receive_time           |window_time                               |
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |6.5        |2.8       |4.6        |1.5       |versicolor|49    |2021-01-02 19:44:20.003|[2021-01-02 19:44:00, 2021-01-02 19:46:00]|
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+

</details>

```python
stream.stop()
```

Видим что в рамках одного окна дубликатов нет.

1\.6\. SLIDING WINDOW

Аналогично предыдущему пункту создаём дополнительное поле `sliding_time`. В функции `F.window` первый аргумент это колонка (временная метка), по которой создаётся окно; второй аргумент - ширина окна; третий - сдвиг окна. Добавляем вотермарку и указываем колонки, по которым будем исключать дубли.

```python
sliding_iris = extended_iris.withColumn("sliding_time", F.window(F.col("receive_time"), "1 minute", "30 seconds"))
waterwarked_sliding_iris = sliding_iris.withWatermark("sliding_time", "2 minutes")
deduplicated_sliding_iris = waterwarked_sliding_iris.drop_duplicates(["species", "sliding_time"])
deduplicated_sliding_iris.printSchema()
```

    root
     |-- sepalLength: float (nullable = true)
     |-- sepalWidth: float (nullable = true)
     |-- petalLength: float (nullable = true)
     |-- petalWidth: float (nullable = true)
     |-- species: string (nullable = true)
     |-- offset: long (nullable = true)
     |-- receive_time: timestamp (nullable = false)
     |-- sliding_time: struct (nullable = true)
     |    |-- start: timestamp (nullable = true)
     |    |-- end: timestamp (nullable = true)


Запускаем стрим.

```python
stream = console_output(deduplicated_sliding_iris , 20)
```

<details>
<summary>Результат выполнения в консоли</summary>

    -------------------------------------------                                     
    Batch: 0
    -------------------------------------------
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species   |offset|receive_time           |sliding_time                              |
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |5.0        |3.0       |1.6        |0.2       |setosa    |2     |2021-01-02 19:49:24.042|[2021-01-02 19:49:00, 2021-01-02 19:50:00]|
    |6.3        |2.8       |5.1        |1.5       |virginica |0     |2021-01-02 19:49:24.042|[2021-01-02 19:49:00, 2021-01-02 19:50:00]|
    |6.3        |2.8       |5.1        |1.5       |virginica |0     |2021-01-02 19:49:24.042|[2021-01-02 19:48:30, 2021-01-02 19:49:30]|
    |6.3        |3.3       |4.7        |1.6       |versicolor|1     |2021-01-02 19:49:24.042|[2021-01-02 19:48:30, 2021-01-02 19:49:30]|
    |5.0        |3.0       |1.6        |0.2       |setosa    |2     |2021-01-02 19:49:24.042|[2021-01-02 19:48:30, 2021-01-02 19:49:30]|
    |6.3        |3.3       |4.7        |1.6       |versicolor|1     |2021-01-02 19:49:24.042|[2021-01-02 19:49:00, 2021-01-02 19:50:00]|
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    
    -------------------------------------------                                     
    Batch: 1
    -------------------------------------------
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species   |offset|receive_time           |sliding_time                              |
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |5.7        |3.8       |1.7        |0.3       |setosa    |6     |2021-01-02 19:49:40.803|[2021-01-02 19:49:30, 2021-01-02 19:50:30]|
    |6.1        |3.0       |4.6        |1.4       |versicolor|7     |2021-01-02 19:49:40.803|[2021-01-02 19:49:30, 2021-01-02 19:50:30]|
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    
    -------------------------------------------                                     
    Batch: 2
    -------------------------------------------
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species   |offset|receive_time           |sliding_time                              |
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |5.5        |2.4       |3.8        |1.1       |versicolor|14    |2021-01-02 19:50:00.003|[2021-01-02 19:50:00, 2021-01-02 19:51:00]|
    |5.1        |3.8       |1.6        |0.2       |setosa    |12    |2021-01-02 19:50:00.003|[2021-01-02 19:50:00, 2021-01-02 19:51:00]|
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    
    -------------------------------------------                                     
    Batch: 3
    -------------------------------------------
    +-----------+----------+-----------+----------+---------+------+-----------------------+------------------------------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species  |offset|receive_time           |sliding_time                              |
    +-----------+----------+-----------+----------+---------+------+-----------------------+------------------------------------------+
    |6.7        |2.5       |5.8        |1.8       |virginica|19    |2021-01-02 19:50:20.003|[2021-01-02 19:49:30, 2021-01-02 19:50:30]|
    |6.7        |2.5       |5.8        |1.8       |virginica|19    |2021-01-02 19:50:20.003|[2021-01-02 19:50:00, 2021-01-02 19:51:00]|
    +-----------+----------+-----------+----------+---------+------+-----------------------+------------------------------------------+
    
    -------------------------------------------                                     
    Batch: 4
    -------------------------------------------
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |sepalLength|sepalWidth|petalLength|petalWidth|species   |offset|receive_time           |sliding_time                              |
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    |5.1        |3.8       |1.9        |0.4       |setosa    |26    |2021-01-02 19:50:40.003|[2021-01-02 19:50:30, 2021-01-02 19:51:30]|
    |5.5        |2.3       |4.0        |1.3       |versicolor|24    |2021-01-02 19:50:40.003|[2021-01-02 19:50:30, 2021-01-02 19:51:30]|
    |6.4        |2.8       |5.6        |2.2       |virginica |25    |2021-01-02 19:50:40.003|[2021-01-02 19:50:30, 2021-01-02 19:51:30]|
    +-----------+----------+-----------+----------+----------+------+-----------------------+------------------------------------------+
    
</details>

Тут так же видим что в рамках каждого окна нет дубликатов. В третьем миробатче хорошо видно, как одна и та же запись с `offset = 19` является новой для обоих окон `19:49:30 - 19:50:30` и `19:50:00 - 19:51:00`.


```python
stream.stop()
```

1\.7\. OUTPUT MODES - считаем суммы

Переопределяем метод `console_output` так, чтобы можно было задавать режим вывода результата работы аггрегационных функций.

```python
def console_output(df, freq, out_mode):
    return df.writeStream.format("console") \
        .trigger(processingTime='%s seconds' % freq ) \
        .options(truncate=False) \
        .option("checkpointLocation", "checkpoints/watermark_console_chk2") \
        .outputMode(out_mode) \
        .start()
```

Используем ранее созданный датафрейм с вотермаркой на 2 минуты. Группируем данные по нескользящему окну `window_time`. 

```python
count_iris = waterwarked_windowed_iris.groupBy("window_time").count()
```

Перед каждым запуском очищаем чекпойнт командой `hdfs dfs -rm -r checkpoints/watermark_console_chk2`.

###### update

```python
stream = console_output(count_iris , 20, "update")
stream.stop()
```

<details>
<summary>Результат выполнения в консоли</summary>

    -------------------------------------------                                     
    Batch: 0
    -------------------------------------------
    +------------------------------------------+-----+
    |window_time                               |count|
    +------------------------------------------+-----+
    |[2021-01-02 20:00:00, 2021-01-02 20:02:00]|6    |
    +------------------------------------------+-----+
    
    -------------------------------------------                                     
    Batch: 1
    -------------------------------------------
    +------------------------------------------+-----+
    |window_time                               |count|
    +------------------------------------------+-----+
    |[2021-01-02 20:02:00, 2021-01-02 20:04:00]|6    |
    +------------------------------------------+-----+
    
    -------------------------------------------                                     
    Batch: 2
    -------------------------------------------
    +------------------------------------------+-----+
    |window_time                               |count|
    +------------------------------------------+-----+
    |[2021-01-02 20:02:00, 2021-01-02 20:04:00]|12   |
    +------------------------------------------+-----+
    
    -------------------------------------------                                     
    Batch: 3
    -------------------------------------------
    +------------------------------------------+-----+
    |window_time                               |count|
    +------------------------------------------+-----+
    |[2021-01-02 20:02:00, 2021-01-02 20:04:00]|18   |
    +------------------------------------------+-----+

</details>

В режиме `.outputMode("update")` в консоль пишутся только обновляющиеся записи. Считатся `count` по каждому окну и выводятся записи только о тех окнах, в которых значение поменялось. 


###### complete

```python
stream = console_output(count_iris , 20, "complete")
stream.stop()
```

<details>
<summary>Результат выполнения в консоли</summary>

    -------------------------------------------                                     
    Batch: 0
    -------------------------------------------
    +------------------------------------------+-----+
    |window_time                               |count|
    +------------------------------------------+-----+
    |[2021-01-02 20:12:00, 2021-01-02 20:14:00]|6    |
    +------------------------------------------+-----+
    
    -------------------------------------------                                     
    Batch: 1
    -------------------------------------------
    +------------------------------------------+-----+
    |window_time                               |count|
    +------------------------------------------+-----+
    |[2021-01-02 20:14:00, 2021-01-02 20:16:00]|6    |
    |[2021-01-02 20:12:00, 2021-01-02 20:14:00]|6    |
    +------------------------------------------+-----+
    
    -------------------------------------------                                     
    Batch: 2
    -------------------------------------------
    +------------------------------------------+-----+
    |window_time                               |count|
    +------------------------------------------+-----+
    |[2021-01-02 20:14:00, 2021-01-02 20:16:00]|12   |
    |[2021-01-02 20:12:00, 2021-01-02 20:14:00]|6    |
    +------------------------------------------+-----+
    
    -------------------------------------------                                     
    Batch: 3
    -------------------------------------------
    +------------------------------------------+-----+
    |window_time                               |count|
    +------------------------------------------+-----+
    |[2021-01-02 20:14:00, 2021-01-02 20:16:00]|18   |
    |[2021-01-02 20:12:00, 2021-01-02 20:14:00]|6    |
    +------------------------------------------+-----+
    
    -------------------------------------------                                     
    Batch: 4
    -------------------------------------------
    +------------------------------------------+-----+
    |window_time                               |count|
    +------------------------------------------+-----+
    |[2021-01-02 20:14:00, 2021-01-02 20:16:00]|24   |
    |[2021-01-02 20:12:00, 2021-01-02 20:14:00]|6    |
    +------------------------------------------+-----+
    
    -------------------------------------------                                     
    Batch: 5
    -------------------------------------------
    +------------------------------------------+-----+
    |window_time                               |count|
    +------------------------------------------+-----+
    |[2021-01-02 20:14:00, 2021-01-02 20:16:00]|30   |
    |[2021-01-02 20:12:00, 2021-01-02 20:14:00]|6    |
    +------------------------------------------+-----+
    
    -------------------------------------------                                     
    Batch: 6
    -------------------------------------------
    +------------------------------------------+-----+
    |window_time                               |count|
    +------------------------------------------+-----+
    |[2021-01-02 20:14:00, 2021-01-02 20:16:00]|36   |
    |[2021-01-02 20:12:00, 2021-01-02 20:14:00]|6    |
    +------------------------------------------+-----+
    
    -------------------------------------------                                     
    Batch: 7
    -------------------------------------------
    +------------------------------------------+-----+
    |window_time                               |count|
    +------------------------------------------+-----+
    |[2021-01-02 20:14:00, 2021-01-02 20:16:00]|36   |
    |[2021-01-02 20:12:00, 2021-01-02 20:14:00]|6    |
    |[2021-01-02 20:16:00, 2021-01-02 20:18:00]|6    |
    +------------------------------------------+-----+

</details>
    
В режиме `.outputMode("complete")` в консоль пишутся все  записи. Считается `count` по каждому окну и выводятся результаты подсчёта во всех окнах. 


###### append

Пишем все записи только один раз. Информация выводится один раз, когда окно заканчивается.

```python
stream = console_output(count_iris , 20, "append")
stream.stop()
```

Тут не увидел результата все батчи пустые. Скорее всего данный режим не поддерживается для данной аггрегирующей функции.


1\.8\. Наблюдаем за суммами в плавающем окне.

```python
sliding_iris = waterwarked_sliding_iris.groupBy("sliding_time").count()
stream = console_output(sliding_iris , 20, "update")
stream.stop()
```

<details>
<summary>Результат выполнения в консоли</summary>

    -------------------------------------------                                     
    Batch: 0
    -------------------------------------------
    +------------------------------------------+-----+
    |sliding_time                              |count|
    +------------------------------------------+-----+
    |[2021-01-02 21:09:00, 2021-01-02 21:10:00]|6    |
    |[2021-01-02 21:09:30, 2021-01-02 21:10:30]|6    |
    +------------------------------------------+-----+
    
    -------------------------------------------                                     
    Batch: 1
    -------------------------------------------
    +------------------------------------------+-----+
    |sliding_time                              |count|
    +------------------------------------------+-----+
    |[2021-01-02 21:09:00, 2021-01-02 21:10:00]|12   |
    |[2021-01-02 21:09:30, 2021-01-02 21:10:30]|12   |
    +------------------------------------------+-----+
    
    -------------------------------------------                                     
    Batch: 2
    -------------------------------------------
    +------------------------------------------+-----+
    |sliding_time                              |count|
    +------------------------------------------+-----+
    |[2021-01-02 21:10:00, 2021-01-02 21:11:00]|6    |
    |[2021-01-02 21:09:30, 2021-01-02 21:10:30]|18   |
    +------------------------------------------+-----+
    
    -------------------------------------------                                     
    Batch: 3
    -------------------------------------------
    +------------------------------------------+-----+
    |sliding_time                              |count|
    +------------------------------------------+-----+
    |[2021-01-02 21:10:00, 2021-01-02 21:11:00]|12   |
    |[2021-01-02 21:10:30, 2021-01-02 21:11:30]|6    |
    +------------------------------------------+-----+

</details>

Наблюдаем только обновляющиеся записи в каждом плавающем окне. 

##### Задание 2. Сджойнить стрим со статикой.

Создадим статический датафрейм, который будет расширять исходный датасет ирисов.

```python
static_df_schema = StructType() \
    .add("species", StringType()) \
    .add("description", StringType())
    
static_df_data = (
    ("setosa", "Iris setosa has a deep violet blue flower. The sepals are deeply-veined dark purple with a yellow-white signal."),
    ("versicolor", "Iris versicolor is a flowering herbaceous perennial plant, growing 10-80 cm high. The well developed blue flower has 6 petals and sepals spread out nearly flat and have two forms."),
    ("virginica", "Iris virginica is a perennial plant. The plant has 2 to 4 erect or arching, bright green, lance-shaped leaves that are flattened into one plane at the base.")
)

static_df = spark.createDataFrame(static_df_data, static_df_schema)
```

```python
static_joined = waterwarked_iris.join(static_df, "species", "left")
static_joined.isStreaming
```

    True
    
После джойна стрима со статикой получаем стрим. 
    
```python
static_joined.printSchema()
```

    root
     |-- species: string (nullable = true)
     |-- sepalLength: float (nullable = true)
     |-- sepalWidth: float (nullable = true)
     |-- petalLength: float (nullable = true)
     |-- petalWidth: float (nullable = true)
     |-- offset: long (nullable = true)
     |-- receive_time: timestamp (nullable = false)
     |-- description: string (nullable = true)

Добавлась колонка `description`.

```python
stream = console_output(static_joined , 20, "update")
stream.stop()
```

    -------------------------------------------                                     
    Batch: 0
    -------------------------------------------
    +----------+-----------+----------+-----------+----------+------+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    |species   |sepalLength|sepalWidth|petalLength|petalWidth|offset|receive_time           |description                                                                                                                                                                        |
    +----------+-----------+----------+-----------+----------+------+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    |virginica |6.3        |2.8       |5.1        |1.5       |0     |2021-01-03 06:35:25.794|Iris virginica is a perennial plant. The plant has 2 to 4 erect or arching, bright green, lance-shaped leaves that are flattened into one plane at the base.                       |
    |versicolor|6.3        |3.3       |4.7        |1.6       |1     |2021-01-03 06:35:25.794|Iris versicolor is a flowering herbaceous perennial plant, growing 10-80 cm high. The well developed blue flower has 6 petals and sepals spread out nearly flat and have two forms.|
    |versicolor|5.6        |2.5       |3.9        |1.1       |3     |2021-01-03 06:35:25.794|Iris versicolor is a flowering herbaceous perennial plant, growing 10-80 cm high. The well developed blue flower has 6 petals and sepals spread out nearly flat and have two forms.|
    |versicolor|5.7        |2.6       |3.5        |1.0       |5     |2021-01-03 06:35:25.794|Iris versicolor is a flowering herbaceous perennial plant, growing 10-80 cm high. The well developed blue flower has 6 petals and sepals spread out nearly flat and have two forms.|
    |setosa    |5.0        |3.0       |1.6        |0.2       |2     |2021-01-03 06:35:25.794|Iris setosa has a deep violet blue flower. The sepals are deeply-veined dark purple with a yellow-white signal.                                                                    |
    |setosa    |5.4        |3.9       |1.7        |0.4       |4     |2021-01-03 06:35:25.794|Iris setosa has a deep violet blue flower. The sepals are deeply-veined dark purple with a yellow-white signal.                                                                    |
    +----------+-----------+----------+-----------+----------+------+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    
    -------------------------------------------                                     
    Batch: 1
    -------------------------------------------
    +----------+-----------+----------+-----------+----------+------+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    |species   |sepalLength|sepalWidth|petalLength|petalWidth|offset|receive_time           |description                                                                                                                                                                        |
    +----------+-----------+----------+-----------+----------+------+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    |versicolor|6.1        |3.0       |4.6        |1.4       |7     |2021-01-03 06:35:40.004|Iris versicolor is a flowering herbaceous perennial plant, growing 10-80 cm high. The well developed blue flower has 6 petals and sepals spread out nearly flat and have two forms.|
    |versicolor|6.3        |2.5       |4.9        |1.5       |9     |2021-01-03 06:35:40.004|Iris versicolor is a flowering herbaceous perennial plant, growing 10-80 cm high. The well developed blue flower has 6 petals and sepals spread out nearly flat and have two forms.|
    |versicolor|4.9        |2.4       |3.3        |1.0       |10    |2021-01-03 06:35:40.004|Iris versicolor is a flowering herbaceous perennial plant, growing 10-80 cm high. The well developed blue flower has 6 petals and sepals spread out nearly flat and have two forms.|
    |setosa    |5.7        |3.8       |1.7        |0.3       |6     |2021-01-03 06:35:40.004|Iris setosa has a deep violet blue flower. The sepals are deeply-veined dark purple with a yellow-white signal.                                                                    |
    |setosa    |5.4        |3.4       |1.7        |0.2       |8     |2021-01-03 06:35:40.004|Iris setosa has a deep violet blue flower. The sepals are deeply-veined dark purple with a yellow-white signal.                                                                    |
    |setosa    |5.1        |3.7       |1.5        |0.4       |11    |2021-01-03 06:35:40.004|Iris setosa has a deep violet blue flower. The sepals are deeply-veined dark purple with a yellow-white signal.                                                                    |
    +----------+-----------+----------+-----------+----------+------+-----------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+


##### Задание 3. Сджойнить стрим со стримом.

Это задание сделаем на примере датасетов товаров и заказов.

Датасет, соотносящий товары и заказы читаем из кафки, топик `order_items`.

```python
raw_orders_items = spark.readStream. \
    format("kafka"). \
    option("kafka.bootstrap.servers", kafka_brokers). \
    option("subscribe", "order_items"). \
    option("startingOffsets", "earliest"). \
    load()
```

Разбираем value и добавляем окно.

```python
schema_orders_items = StructType() \
    .add("order_id", StringType()) \
    .add("order_item_id", StringType()) \
    .add("product_id", StringType()) \
    .add("seller_id", StringType()) \
    .add("shipping_limit_date", StringType()) \
    .add("price", StringType()) \
    .add("freight_value", StringType())

extended_orders_items = raw_orders_items \
    .select(F.from_json(F.col("value").cast("String"), schema_orders_items).alias("value")) \
    .select("value.*") \
    .withColumn("order_items_receive_time", F.current_timestamp()) \
    .withColumn("window_time",F.window(F.col("order_items_receive_time"),"2 minutes"))

extended_orders_items.printSchema()
```

    root
     |-- order_id: string (nullable = true)
     |-- order_item_id: string (nullable = true)
     |-- product_id: string (nullable = true)
     |-- seller_id: string (nullable = true)
     |-- shipping_limit_date: string (nullable = true)
     |-- price: string (nullable = true)
     |-- freight_value: string (nullable = true)
     |-- order_items_receive_time: timestamp (nullable = false)
     |-- window_time: struct (nullable = false)
     |    |-- start: timestamp (nullable = true)
     |    |-- end: timestamp (nullable = true)


Датасет списка заказов читаем из кафки, топик `orders_json`.

```python
raw_orders = spark.readStream. \
    format("kafka"). \
    option("kafka.bootstrap.servers", kafka_brokers). \
    option("subscribe", "orders_json"). \
    option("maxOffsetsPerTrigger", "5"). \
    option("startingOffsets", "earliest"). \
    load()
```

Разбираем value, добавляем колонку со временем получения сообщения,создаём по ней окно и добавляем вотермарку.

```python
schema = StructType() \
    .add("order_id", StringType()) \
    .add("customer_id", StringType()) \
    .add("order_status", StringType()) \
    .add("order_purchase_timestamp", StringType()) \
    .add("order_approved_at", StringType()) \
    .add("order_delivered_carrier_date", StringType()) \
    .add("order_delivered_customer_date", StringType()) \
    .add("order_estimated_delivery_date", StringType())

waterwarked_windowed_orders = raw_orders \
    .select(F.from_json(F.col("value").cast("String"), schema).alias("value"), "offset") \
    .select("value.order_id", "value.order_status", "value.order_purchase_timestamp") \
    .withColumn("order_receive_time", F.current_timestamp()) \
    .withColumn("window_time",F.window(F.col("order_receive_time"),"2 minutes")) \
    .withWatermark("window_time", "2 minutes")
    
waterwarked_windowed_orders.printSchema()
```

    root
     |-- order_id: string (nullable = true)
     |-- order_status: string (nullable = true)
     |-- order_purchase_timestamp: string (nullable = true)
     |-- order_receive_time: timestamp (nullable = false)
     |-- window_time: struct (nullable = false)
     |    |-- start: timestamp (nullable = true)
     |    |-- end: timestamp (nullable = true)


Делаем джойн двух датасетов. 

```python
streams_joined = waterwarked_windowed_orders \
    .join(extended_orders_items, ["order_id", "window_time"] , "inner") \
    .select("order_id", "order_item_id", "product_id", "window_time")
```

Тип отображения `update`не подходит для `inner` джойна.

```python
stream = console_output(streams_joined , 20, "append")
stream.stop()
```

Здесь не увидел результата, так как в топике `order_items` не было данных. По факту этот топик вычитывается целиком за раз, поэтому в первом окне можно наблюдать микробатчи сджойненого датасета. Для остальных окон микробатчи пустые, так как `window_time` уже различаются. Из топика `order_items` новые данные не приходят.
